# SAM3 标注工具

一个基于 SAM3 模型的智能标注软件，支持目标检测和分割标注，可生成 labelme 格式的 JSON 文件。

## 功能特点

- 🤖 **AI 辅助标注**: 使用 SAM3 模型自动生成高质量的分割 mask
- 🎯 **双任务模式**:
  - **分割模式 (Mask)**: 生成精确的分割 mask
  - **检测模式 (Box)**: 只生成边界框，速度更快
- 🎨 **多种标注方式**:
  - 文本提示: 输入类别名称自动检测所有目标（默认：rectangle）
  - 点提示: 点击前景/背景点生成精确分割
  - 框提示: 绘制边界框生成 mask
  - **编辑模式**: 可视化调整标注点和边界框
- 📁 **批量处理**: 支持加载整个文件夹，快速切换图片标注
- ⌨️ **快捷键支持**: A/D 键切换图片，E 键编辑，Delete 键删除
- 💾 **自动保存**: 切换图片时自动保存当前标注
- ✏️ **标注微调**: 支持编辑标签、拖动控制点、拖动整体标注、删除标注
- 💾 **Labelme 格式**: 完全兼容 labelme 格式，支持导入导出
- 🖼️ **可视化**: 实时显示标注结果，支持 mask 和边界框显示
- 🔍 **图像缩放**: 鼠标滚轮缩放，中键拖动，便于查看细节
- ⚡ **性能优化**: 高性能模式，大图标注流畅不卡

## 安装

### 1. 安装主项目依赖

```bash
pip install -r requirements.txt
```

### 2. 安装标注工具额外依赖

```bash
pip install -r requirements_annotator.txt
```

或者手动安装:

```bash
pip install PyQt5>=5.15.0 scikit-image>=0.19.0
```

## 使用方法

### 启动标注工具

```bash
python sam3_annotator.py
```

### 标注流程

#### 1. 加载模型

- 在左侧"模型设置"区域，点击"浏览模型"选择 SAM3 模型文件（.pt 或 .pth）
- 点击"加载模型"按钮加载模型
- 等待模型加载完成（状态显示为绿色"模型: 已加载"）

推荐模型路径:
```
experiments/checkpoints/model_fp16.pt
```

#### 2. 加载图像

**方式一：加载单张图像**
- 在"图像操作"区域，点击"加载单张图像"
- 选择要标注的图像文件（支持 png, jpg, jpeg, bmp, tif）

**方式二：加载文件夹（推荐）**
- 点击"加载文件夹"按钮
- 选择包含图像的文件夹
- 自动加载文件夹中所有图像
- 使用 **A/D 键**或按钮切换图片

#### 3. 选择任务类型

首先选择任务类型：
- **分割 (Mask)** - 生成精确的分割 mask，适合需要像素级标注的任务
- **检测 (Box)** - 只生成边界框，速度快，适合目标检测任务

#### 4. 选择标注方式

**方式一: 文本提示（批量标注）**

1. 在"标注模式"下拉框选择"文本提示"
2. 在"文本提示"输入框输入类别名称，如: `car`, `person`, `dog` 等
3. 设置"置信度阈值"（推荐 0.3-0.5）
4. 在"当前标签"输入框输入标签名称
5. 点击"运行文本提示"，模型会自动检测图像中的所有目标

**方式二: 点提示（精确标注）**

1. 选择"点提示"模式
2. 在图像上点击：
   - **左键**: 添加前景点（要分割的目标）
   - **右键**: 添加背景点（不要的区域）
3. 添加足够的点后，点击"运行点提示"生成 mask
4. 点击"清除点"可以重新开始

**方式三: 框提示（快速标注）**

1. 选择"框提示"模式
2. 在图像上拖拽鼠标绘制边界框
3. 释放鼠标后自动生成 mask

#### 4. 编辑标注

**方式 D: 编辑模式（精确调整）**

1. 选择 **"编辑模式"** 或按 **E 键**
2. 点击标注选中它（会高亮显示）
3. **拖动控制点**调整位置：
   - 边界框：拖动四个角点调整大小和位置
   - 多边形：拖动顶点调整形状
4. 按 **Delete 键**删除选中的标注

**其他编辑操作：**
- **修改标签**: 双击右侧标注列表中的项目，输入新标签名
- **删除标注**: 选中标注后按 Delete 键，或点击 **"删除"** 按钮
- **清空所有**: 点击 **"清空"** 按钮清除所有标注

#### 5. 保存标注

**自动保存（文件夹模式）：**
- 切换图片时自动保存当前标注
- JSON 文件与图像同名，保存在同一目录
- 状态栏会显示"✓ 已自动保存上一张的标注"

**手动保存：**
- 点击"保存为 JSON"按钮或按 **Ctrl+S**
- 选择保存位置（默认与图像同名）
- 生成 labelme 格式的 JSON 文件

**加载已有标注：**
- 切换到图片时，如果存在同名 JSON，会自动加载
- 可以继续编辑已有的标注

#### 6. 加载已有标注

- 点击"加载 JSON"按钮
- 选择 labelme 格式的 JSON 文件
- 自动加载对应的图像和标注

## Labelme 格式说明

生成的 JSON 文件格式与 labelme 完全兼容，包含:

```json
{
  "version": "5.0.1",
  "shapes": [
    {
      "label": "car",
      "points": [[x1, y1], [x2, y2], ...],
      "shape_type": "polygon",
      "group_id": null,
      "flags": {}
    }
  ],
  "imagePath": "image.jpg",
  "imageData": "base64_encoded_image_data",
  "imageHeight": 1080,
  "imageWidth": 1920
}
```

可以使用 labelme 软件打开和编辑生成的 JSON 文件。

## 快捷键

### 图像导航
- **A 键**: 上一张图片
- **D 键**: 下一张图片

### 模式切换
- **E 键**: 切换到编辑模式

### 标注操作
- **左键点击**: 添加前景点（点提示模式）/ 选择标注（编辑模式）
- **右键点击**: 添加背景点（点提示模式）
- **拖拽鼠标**: 绘制边界框（框提示模式）
- **拖动控制点**: 调整形状大小（编辑模式）
- **拖动标注主体**: 移动整个标注（编辑模式）⭐
- **Delete/Backspace**: 删除选中的标注

### 视图控制
- **鼠标滚轮**: 缩放图像
- **鼠标中键拖动**: 平移图像（按住中键拖动）
- **+ 键**: 放大图像
- **- 键**: 缩小图像
- **0 键**: 重置缩放（1:1）
- **R 键**: 重置视图（缩放+偏移）

### 文件操作
- **Ctrl+S**: 保存当前标注

## 标注技巧

### 文本提示模式

- 适合批量标注同类目标
- 尽量使用简单明确的类别名称
- 调整置信度阈值以控制检测数量
- 示例: `person`, `car`, `dog`, `cat`, `tree`

### 点提示模式

- 适合精确标注单个复杂目标
- 前景点放在目标内部
- 背景点放在不想包含的区域
- 通常 3-5 个点即可获得好的结果

### 框提示模式

- 适合快速标注规则形状的目标
- 框要完整包含目标
- 模型会自动精确分割目标边界

## 参数说明

### 置信度阈值
- 范围: 0.0 - 1.0
- 默认: 0.3
- 说明: 文本提示模式下，只保留置信度高于此阈值的检测结果

### 当前标签
- 说明: 新标注的默认标签名称
- 建议: 使用有意义的类别名称，如 `person`, `car` 等

## 常见问题

### Q: 模型加载失败
A: 检查模型文件路径是否正确，确保是 SAM3 的模型文件（.pt 或 .pth）

### Q: 标注结果不准确
A: 
- 尝试调整置信度阈值
- 使用点提示模式添加更多前景/背景点
- 使用框提示模式提供更准确的初始框

### Q: 保存的 JSON 文件过大
A: 这是正常的，因为包含了 base64 编码的图像数据，确保与 labelme 兼容

### Q: 如何在现有标注基础上继续标注
A: 使用"加载 JSON"功能加载已有标注，然后继续添加新标注

## 示例工作流程

### 工作流 1: 批量标注文件夹

```bash
# 1. 启动标注工具
python sam3_annotator.py

# 2. 加载模型
#    - 点击"浏览模型"
#    - 选择: experiments/checkpoints/model_fp16.pt
#    - 点击"加载模型"

# 3. 加载文件夹
#    - 点击"加载文件夹"
#    - 选择包含图像的文件夹
#    - 显示: "已加载 50 张图像"

# 4. 开始标注
#    - 使用文本提示 "car" 自动检测
#    - 按 D 键切换到下一张
#    - 标注会自动保存
#    - 重复直到完成所有图片

# 5. 快速操作
#    A 键 - 上一张
#    D 键 - 下一张
#    滚轮 - 查看细节
#    自动保存 - 无需手动保存
```

### 工作流 2: 精确标注单张复杂图像

```bash
# 1. 加载图像后
# 2. 使用点提示模式
#    - 左键点击目标内部
#    - 右键点击不要的区域
#    - 运行点提示
# 3. 微调标签名称
# 4. Ctrl+S 保存
```

## 与 labelme 的集成

生成的 JSON 文件可以直接用 labelme 打开:

```bash
# 安装 labelme
pip install labelme

# 打开标注文件
labelme image.json

# 或者打开整个目录
labelme /path/to/images/
```

## 技术细节

- **GUI 框架**: PyQt5
- **模型**: SAM3 (Segment Anything Model 3)
- **图像处理**: PIL, numpy, scikit-image
- **格式兼容**: 完全兼容 labelme 5.0.1 格式

## 开发和扩展

如果需要自定义标注工具，可以修改 `sam3_annotator.py`:

- `Canvas` 类: 画布显示和交互
- `SAM3AnnotatorApp` 类: 主窗口和业务逻辑
- `_convert_to_labelme_format` 方法: 格式转换逻辑
- `_mask_to_polygon` 方法: mask 到多边形的转换

## 许可证

遵循主项目的许可证。

## 致谢

- SAM3 模型
- Labelme 项目
- PyQt5 框架

